function SetDropZone(){var e=$("#DragAndDropFilesZone");e.height(200),e.width(1200),e.css("background-color","white"),e.css("border-style","dashed"),e.css("border-width","5px"),e.droppable(),e.on("dragover",function(){return e.css("background-color","blue"),!1}),e.on("dragleave",function(){return e.css("background-color","red"),e.css("border-style","dashed"),e.css("border-width","5px"),!1}),e.on("drop",function(t){t.stopPropagation(),t.preventDefault(),e.css("background-color","white"),e.css("border-style","dashed"),e.css("border-width","5px"),e.removeClass("hover");var a=t.originalEvent.dataTransfer.files;return ProcessFiles(a),!1})}function ProcessFiles(e){if(e&&"undefined"!=typeof FileReader){$ImagesTobeEditedArray=[e.length];for(var t=0;t<e.length;t++)readFile(e[t])}}function setpixelated(e){e.imageSmoothingEnabled=!1,e.mozImageSmoothingEnabled=!1,e.oImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1}function ResizeFactory(e,t){var a=document.createElement("canvas");a.width=e.width*t,a.height=e.height*t;var i=a.getContext("2d");return i.drawImage(e,0,0,e.width*t,e.height*t),a}function LoadPreviews(){for(var e=0;e<$ImagesTobeEditedArray.lenght;e++)createPreviews(e)}function createPreviews(e){var t=$ImagesTobeEditedArray[e].GetTempSmallCanvas().toDataURL("image/jpeg"),a=$ImagesTobeEditedArray[e].GetTempBigCanvas().toDataURL("image/jpeg"),i="data:image/jpeg;base64,",r=Math.round(3*(a.length-i.length)/4),n="ImgPreview"+e,g="div"+e,o="editImgPreview"+e,d=ImageHTMLForPreview(n,t,r),s=ImageHTMLForPreview(o,a,r),m=DivHTMLForPreview(g,d);$("#"+g).remove(""),$("#ShowUpPics").append(m),CreateDialogs(n,m,s,a)}function REcreatePreviews(e){var t=$ImagesTobeEditedArray[e].GetTempSmallCanvas().toDataURL("image/jpeg"),a=$ImagesTobeEditedArray[e].GetTempBigCanvas().toDataURL("image/jpeg"),i="data:image/jpeg;base64,",r=Math.round(3*(a.length-i.length)/4),n="ImgPreview"+e,g="div"+e,o="editImgPreview"+e,d=ImageHTMLForPreview(n,t,r),s=ImageHTMLForPreview(o,a,r),m=DivHTMLForPreview(g,d);$("#"+g).html(""),$("#"+g).append(d),CreateDialogs(n,m,s,a)}function ImageHTMLForPreview(e,t,a){var i="<img id='"+e+"' src='"+t+"'></img> <br><p>"+a+"</p>";return i}function DivHTMLForPreview(e,t){var a="<div id='div"+e+"' class='Previews'>"+t+"</div>";return a}function app(e,t,a,i){var r=$ImagesTobeEditedArray[i].GetSmallCanvas().toDataURL("image/jpeg"),n=$ImagesTobeEditedArray[i].GetBigCanvas().toDataURL("image/jpeg"),g="data:image/jpeg;base64,",o=Math.round(3*(r.length-g.length)/4),d="img"+i,s="<img id='"+d+"' src='"+r+"'></img> <br><p>"+o+"</p>",m="<img id='edit"+d+"' src='"+n+"'></img> <br><p>"+o+"</p>",h="<div id='div"+d+"' class='Previews'>"+s+"</div>";$("#ShowUpPics").append(h),CreateDialogs(d,h,m,n)}function appReplace(e,t,a){var i="data:image/jpeg;base64,",r=Math.round(3*(e.length-i.length)/4),n="img"+a,g="<img id='"+n+"' src='"+e+"'></img> <br><p>"+r+"</p>",o="<img id='edit"+n+"' src='"+t+"'></img> <br><p>"+r+"</p>",d="<div id='div"+n+"' class='Previews'>"+g+"</div>";$("#div"+n).html(""),$("#div"+n).append(g),CreateDialogs(n,d,o,t)}function CreateDialogs(e,t,a,i){$(function(){$("#"+e).click(function(){var t=$("#"+e).parent().attr("id"),r=($("#"+t).clone(),$("#"+t).html(),"edit"+e.trim()),n=a+'<br> Sharpen: <input type="range" id="mix" min="-200" max="200" value="0" oninput="update(\''+r+"')\">",g=i;createCanvasForDialog(g),$(".olddialog").remove(),$('<div id="Editdialog" class="olddialog"></div>').dialog({dialogClass:"FotoEditingDialog",position:[$(window).width()/2-200,150],modal:!0,title:"Edit Picture",open:function(){$(this).html(n)},buttons:{Save:function(){var t=e.replace("ImgPreview",""),a=document.createElement("canvas");a.width=$ImagesTobeEditedArray[t].GetTempSmallCanvas().width,a.height=$ImagesTobeEditedArray[t].GetTempSmallCanvas().height;var i=a.getContext("2d"),r=$ImagesTobeEditedArray[t].GetTempSmallCanvas().getContext("2d");i=sharpen(r,a.width,a.height,.01*parseInt($ans1Value)),$ans1Value=0/0,$ImagesTobeEditedArray[t].SetTempSmallCanvas(a),REcreatePreviews(t),$("#Editdialog").dialog("close"),$("#Editdialog").dialog("destroy").remove(),$("#Editdialog").empty(),$("#Editdialog").remove()}}})})})}function createCanvasForDialog(e){var t=document.createElement("canvas"),a=new Image;a.onload=function(){t.width=a.width,t.height=a.height;var e=t.getContext("2d");e.drawImage(a,0,0,a.width,a.height),$canvasSharp=t},a.src=e}function Resize(e){{var t=document.getElementById("canvas");t.getContext("2d")}img=new Image,img.onload=function(){t.height=t.width*(img.height/img.width);var e=document.createElement("canvas"),a=e.getContext("2d"),i=new ImageSizeMax(img);i.CalculateSize(),e.width=i.width,e.height=i.height,a.drawImage(img,0,0,e.width,e.height);var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var n=r.getContext("2d");n.drawImage(e,0,0,e.width,e.height);var g=r.toDataURL("image/jpeg");$("#ShowUpPics").append("Old image: <img src='"+g+"'></img>")},img.src=e}function update(e){var t="editImgPreview",a=e.replace(t,""),i=document.getElementById(e),r=document.createElement("canvas");r.width=$ImagesTobeEditedArray[a].GetBigCanvas().width,r.height=$ImagesTobeEditedArray[a].GetBigCanvas().height;var n=r.getContext("2d");n.drawImage($ImagesTobeEditedArray[a].GetBigCanvas(),0,0,$ImagesTobeEditedArray[a].GetBigCanvas().width,$ImagesTobeEditedArray[a].GetBigCanvas().height);var g=document.getElementById("mix");$ans1Value=g.value,n=sharpen(n,$ImagesTobeEditedArray[a].GetBigCanvas().width,$ImagesTobeEditedArray[a].GetBigCanvas().height,.01*parseInt($ans1Value)),$ImagesTobeEditedArray[a].SetTempBigCanvas(r),i.src=r.toDataURL("image/jpeg")}function sharpen(e,t,a,i){for(var r=[0,-1,0,-1,5,-1,0,-1,0],n=Math.round(Math.sqrt(r.length)),g=.5*n|0,o=e.createImageData(t,a),d=o.data,s=e.getImageData(0,0,t,a).data,m=a;m--;)for(x=t;x--;){for(var h=m,l=x,v=4*(m*t+x),c=0,p=0,u=0,w=0,I=0;n>I;I++)for(var C=0;n>C;C++){var f=h+I-g,T=l+C-g;if(f>=0&&a>f&&T>=0&&t>T){var $=4*(f*t+T),y=r[I*n+C];c+=s[$]*y,p+=s[$+1]*y,u+=s[$+2]*y,w+=s[$+3]*y}}d[v]=c*i+s[v]*(1-i),d[v+1]=p*i+s[v+1]*(1-i),d[v+2]=u*i+s[v+2]*(1-i),d[v+3]=s[v+3]}return e.putImageData(o,0,0),e}var imgWater=new Image,CanimgWater;imgWater.crossOrigin="anonymous",imgWater.onload=function(){CanimgWater=document.createElement("canvas"),CanimgWater.width=imgWater.width,CanimgWater.height=imgWater.height;var e=CanimgWater.getContext("2d");e.drawImage(imgWater,0,0,imgWater.width,image.height)},imgWater.src="./Firma.png",$(document).ready(function(){SetDropZone()});var readFile=function(e){if(/image/i.test(e.type)){var t=new FileReader;t.onload=function(e){var t=$("<img/>").load(function(){t.crossOrigin="anonymous",getCanvasImage(this)}).attr("src",e.target.result)},t.readAsDataURL(e),$("#err").text("")}else $("#err").text("*Selected file format not supported!")},iID=0,$CanvasToBeUploadedSmall,$CanvasToBeUploadedBig,getCanvasImage=function(e){var t=1200,a=300,i=.5,r=(e.width,e.height,new ImageSizeMax(e,t));r.CalculateSize(),i=1/r.DiffTimes;var n,n=document.createElement("canvas");n.width=e.width,n.height=e.height;var g=n.getContext("2d");for(g.drawImage(e,0,0,e.width,e.height);1>i;){.5>i&&(i=.5),n=ResizeFactory(n,i);var o=new ImageSizeMax(n,t);if(o.CalculateSize(),i=1/o.DiffTimes,!(n.width>1200||n.height>1200))break;i=1/o.DiffTimes}var d=document.createElement("canvas");d.width=n.width,d.height=n.height;var s=d.getContext("2d");for(s.drawImage(e,0,0,n.width,n.height),o=new ImageSizeMax(d,a),o.CalculateSize(),i=1/o.DiffTimes;1>i;){.5>i&&(i=.5),d=ResizeFactory(d,i);var o=new ImageSizeMax(d,a);if(o.CalculateSize(),i=1/o.DiffTimes,!(1>i))break;i=1/o.DiffTimes}$CanvasToBeUploadedSmall=d;var m=$ImagesTobeEditedArray.length-1;isNaN(m)?iID=0:m>iID&&(iID=m),$CanvasToBeUploadedBig=n;var h=new ImagesTobeEdited(e);h.CreateCanvasCouple(d,n),h.CreateTempcanvas(d,n),h.SetImageId(iID),$ImagesTobeEditedArray[iID]=h;var l=$ImagesTobeEditedArray[iID].GetSmallCanvas(),v=l.getContext("2d"),c=document.createElement("canvas");c.width=imgWater.width,c.height=imgWater.height;var p=c.getContext("2d"),u=l.width/imgWater.width*.2;p.drawImage(imgWater,0,0,imgWater.width,imgWater.height);var w=ResizeFactory(c,u),I=w.width,C=w.height;v.drawImage(w,l.width-I,l.height-C,I,C);var f=$ImagesTobeEditedArray[iID].GetBigCanvas(),T=f.getContext("2d"),$=document.createElement("canvas");$.width=imgWater.width,$.height=imgWater.height;var y=($.getContext("2d"),f.width/imgWater.width*.2),S=ResizeFactory(c,y),I=S.width,C=S.height;return T.drawImage(S,f.width-I,f.height-C,I,C),$ImagesTobeEditedArray[iID].CreateTempcanvas(l,f),createPreviews(iID),iID+=1,n.toDataURL("image/jpeg")},$ans1Value,ImageSizeMax=function(){function e(e,t){this.imge=e,this.MaxSize=t}return e.prototype.CalculateSize=function(){this.imge.height,this.imge.width,this.imge.height>this.MaxSize||this.imge.width>this.MaxSize?(this.DiffTimes=this.imge.height>this.imge.width||this.imge.height==this.imge.width?this.imge.height/this.MaxSize:this.imge.width/this.MaxSize,this.height=this.imge.height/this.DiffTimes,this.width=this.imge.width/this.DiffTimes):(this.height=this.imge.height,this.width=this.imge.width,this.DiffTimes=1)},e}(),$canvasSharp,$canvasSharpSwap,ImagesTobeEdited=function(){function e(e){this.ImageType=e}return e.prototype.SetImageId=function(e){this.imageId=e},e.prototype.SetFileName=function(e){this.FileName=e},e.prototype.GetFileName=function(){return this.FileName},e.prototype.CreateSmallCanvas=function(e){this.CanvasSmall=e},e.prototype.CreateBigCanvas=function(e){this.CanvasBig=e},e.prototype.CreateCanvasCouple=function(e,t){this.CanvasSmall=e,this.CanvasBig=t},e.prototype.CreateTempcanvas=function(e,t){this.TempCanvasSmall=e,this.TempCanvasBig=t},e.prototype.GetBigCanvas=function(){return this.CanvasBig},e.prototype.GetSmallCanvas=function(){return this.CanvasSmall},e.prototype.GetTempBigCanvas=function(){return this.TempCanvasBig},e.prototype.GetTempSmallCanvas=function(){return this.TempCanvasSmall},e.prototype.SetTempBigCanvas=function(e){this.TempCanvasBig=e},e.prototype.SetTempSmallCanvas=function(e){this.TempCanvasSmall=e},e.prototype.GetImage=function(){return this.ImageType},e.prototype.GetId=function(){return this.imageId},e}(),$ImagesTobeEditedArray=[];